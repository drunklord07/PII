SET SERVEROUTPUT ON;

DECLARE
    v_sql         VARCHAR2(4000);
    v_output      VARCHAR2(4000);
    v_column_list VARCHAR2(4000);
    c_cursor      SYS_REFCURSOR;
BEGIN
    FOR rec IN (
        SELECT OWNER, TABLE_NAME 
        FROM ALL_TABLES 
        WHERE ROWNUM <= 10  -- Limit for testing
    ) LOOP
        v_column_list := '';

        -- Output the table name
        DBMS_OUTPUT.PUT_LINE('Processing Table: ' || rec.OWNER || '.' || rec.TABLE_NAME);

        BEGIN
            -- Dynamically build column list, excluding certain data types
            FOR col_rec IN (
                SELECT COLUMN_NAME, DATA_TYPE
                FROM ALL_TAB_COLUMNS 
                WHERE OWNER = rec.OWNER 
                  AND TABLE_NAME = rec.TABLE_NAME 
                  AND DATA_TYPE NOT IN ('CLOB', 'BLOB', 'NCLOB', 'LONG RAW', 'XMLTYPE')
                ORDER BY COLUMN_ID
            ) LOOP
                v_column_list := v_column_list || 'TO_CHAR("' || col_rec.COLUMN_NAME || '") || '' | '' || ';
            END LOOP;

            -- Remove the trailing ' || '' | '' || ' from the column list
            IF v_column_list IS NOT NULL THEN
                v_column_list := SUBSTR(v_column_list, 1, LENGTH(v_column_list) - 11);
            ELSE
                DBMS_OUTPUT.PUT_LINE('No valid columns to display for ' || rec.OWNER || '.' || rec.TABLE_NAME);
                CONTINUE;
            END IF;

            -- Output the column list
            DBMS_OUTPUT.PUT_LINE('Columns: ' || v_column_list);

            -- Build the dynamic SQL statement
            v_sql := 'SELECT ' || v_column_list || 
                     ' FROM "' || rec.OWNER || '"."' || rec.TABLE_NAME || 
                     '" WHERE ROWNUM <= 5';

            BEGIN
                -- Execute the dynamic SQL and fetch the results
                OPEN c_cursor FOR v_sql;
                LOOP
                    FETCH c_cursor INTO v_output;
                    EXIT WHEN c_cursor%NOTFOUND;
                    DBMS_OUTPUT.PUT_LINE(v_output);
                END LOOP;
                CLOSE c_cursor;
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    DBMS_OUTPUT.PUT_LINE('No data found in ' || rec.OWNER || '.' || rec.TABLE_NAME);
                WHEN TOO_MANY_ROWS THEN
                    DBMS_OUTPUT.PUT_LINE('Too many rows returned from ' || rec.OWNER || '.' || rec.TABLE_NAME);
                WHEN OTHERS THEN
                    DBMS_OUTPUT.PUT_LINE('Error processing ' || rec.OWNER || '.' || rec.TABLE_NAME || ': ' || SQLERRM);
            END;

        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('Error accessing columns for ' || rec.OWNER || '.' || rec.TABLE_NAME || ': ' || SQLERRM);
        END;
    END LOOP;
END;
/
